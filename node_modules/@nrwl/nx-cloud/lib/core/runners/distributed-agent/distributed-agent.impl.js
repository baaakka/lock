const a6_0xdc60=['Agent\x20','Agent\x20was\x20terminated\x20via\x20SIGINT','done','NO_MESSAGES_TIMEOUT','executionId','length','map','completed:\x20','ignore','../../../utilities/nx-imports','Error:','RUN_GROUP_COMPLETED','throw','--configuration=','catch','error','Duplicate\x20Agent\x20ID\x20Detected','executionId:\x20','retryDuring:\x20','tasks','projectName',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.','status:\x20','criticalErrorMessage','SIGTERM','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','find','NX_AGENT_NAME','error:\x20','parse','join','retryDuring','../../error/print-run-group-error','defineProperty','forEach','toString','reset','readdirSync','env','SIGINT','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','readFileSync','existsSync','/tasks-hashes-','No\x20new\x20messages\x20received\x20after\x20','DistributedAgentApi','cacheDirectory','getRunGroup','../../../utilities/create-unchanged-value-timeout','completedStatusCode','assign','tasksRunnerOptions','maxParallel:\x20','../../../utilities/waiter','true','unlinkSync','VERBOSE_LOGGING','status','createUnchangedValueTimeout','../../../utilities/environment','Waiting...','completed','CIRCLE_STAGE','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','Distributed\x20Execution\x20Terminated','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','random','CIRCLE_JOB','configuration','Executing:\x20\x27','completeRunGroupWithError','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','printRunGroupError','__awaiter','next','getTime','message','Waiter','maxParallel','push','value','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','wait','params','apply','note','target','../../../utilities/metric-logger','projects','strip-json-comments','completedTasks','includes','warn','CIRCLECI','inherit','npx\x20nx\x20run-many\x20--target=','./distributed-agent.api','startAgent','execSync','.lock','Fetching\x20tasks...','exit','number\x20of\x20tasks:\x20','./node_modules/.cache/nx'];(function(_0x26281c,_0xdc600f){const _0x1905dc=function(_0x12fced){while(--_0x12fced){_0x26281c['push'](_0x26281c['shift']());}};_0x1905dc(++_0xdc600f);}(a6_0xdc60,0x104));const a6_0x1905=function(_0x26281c,_0xdc600f){_0x26281c=_0x26281c-0x0;let _0x1905dc=a6_0xdc60[_0x26281c];return _0x1905dc;};'use strict';var __awaiter=this&&this[a6_0x1905('0x15')]||function(_0x28a0a7,_0x2a7239,_0x7489c8,_0x237d33){function _0x2688a9(_0x1792b5){return _0x1792b5 instanceof _0x7489c8?_0x1792b5:new _0x7489c8(function(_0x5de0ab){_0x5de0ab(_0x1792b5);});}return new(_0x7489c8||(_0x7489c8=Promise))(function(_0x2a6bf7,_0x34783c){function _0x1f11a2(_0x13bf75){try{_0x3325a5(_0x237d33[a6_0x1905('0x16')](_0x13bf75));}catch(_0x171faa){_0x34783c(_0x171faa);}}function _0x1081dd(_0x5598d8){try{_0x3325a5(_0x237d33[a6_0x1905('0x40')](_0x5598d8));}catch(_0x428c51){_0x34783c(_0x428c51);}}function _0x3325a5(_0x2023f5){_0x2023f5[a6_0x1905('0x36')]?_0x2a6bf7(_0x2023f5['value']):_0x2688a9(_0x2023f5[a6_0x1905('0x1c')])['then'](_0x1f11a2,_0x1081dd);}_0x3325a5((_0x237d33=_0x237d33[a6_0x1905('0x20')](_0x28a0a7,_0x2a7239||[]))['next']());});};Object[a6_0x1905('0x55')](exports,'__esModule',{'value':!![]});exports[a6_0x1905('0x2d')]=void 0x0;const child_process_1=require('child_process');const fs_1=require('fs');const stripJsonComments=require(a6_0x1905('0x25'));const create_unchanged_value_timeout_1=require(a6_0x1905('0x64'));const environment_1=require(a6_0x1905('0x7'));const metric_logger_1=require(a6_0x1905('0x23'));const waiter_1=require(a6_0x1905('0x1'));const print_run_group_error_1=require(a6_0x1905('0x54'));const distributed_agent_api_1=require(a6_0x1905('0x2c'));const {output,workspaceRoot}=require(a6_0x1905('0x3d'));function executeTasks(_0x179584,_0xdc59de){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x5bbdee=0x0;let _0x34354b=null;const _0x4dd504=(0x0,create_unchanged_value_timeout_1[a6_0x1905('0x6')])({'title':a6_0x1905('0x60')+environment_1[a6_0x1905('0x37')]/0x3e8+'\x20seconds','timeout':environment_1[a6_0x1905('0x37')]});const _0x359f59=new waiter_1[(a6_0x1905('0x19'))]();let _0x50a525=[];const _0x4f8de1=new Date();let _0x7416a1=![];while(!![]){if(environment_1['VERBOSE_LOGGING']){output['note']({'title':a6_0x1905('0x30')});}_0x34354b=yield _0xdc59de['tasks'](_0x34354b?_0x34354b[a6_0x1905('0x38')]:null,_0x5bbdee,_0x50a525);if(environment_1[a6_0x1905('0x4')]){output[a6_0x1905('0x21')]({'title':'API\x20Response','bodyLines':[a6_0x1905('0x3b')+_0x34354b[a6_0x1905('0x9')],a6_0x1905('0x4a')+_0x34354b[a6_0x1905('0x5')],a6_0x1905('0x46')+_0x34354b[a6_0x1905('0x53')],a6_0x1905('0x45')+_0x34354b[a6_0x1905('0x38')],a6_0x1905('0x32')+_0x34354b['tasks'][a6_0x1905('0x39')],a6_0x1905('0x50')+_0x34354b[a6_0x1905('0x4b')],a6_0x1905('0x0')+_0x34354b[a6_0x1905('0x1a')]]});}if(_0x34354b[a6_0x1905('0x4b')]){output['error']({'title':a6_0x1905('0xc'),'bodyLines':[a6_0x1905('0x3e'),_0x34354b[a6_0x1905('0x4b')]]});process[a6_0x1905('0x31')](0x0);}if((_0x34354b===null||_0x34354b===void 0x0?void 0x0:_0x34354b['retryDuring'])&&(_0x34354b===null||_0x34354b===void 0x0?void 0x0:_0x34354b[a6_0x1905('0x53')])!==0x0&&!_0x7416a1&&new Date()[a6_0x1905('0x17')]()-_0x4f8de1[a6_0x1905('0x17')]()>_0x34354b[a6_0x1905('0x53')]){yield _0x359f59[a6_0x1905('0x1e')]();continue;}if((_0x34354b===null||_0x34354b===void 0x0?void 0x0:_0x34354b[a6_0x1905('0x5')])!==undefined){if(_0x34354b[a6_0x1905('0x5')]===a6_0x1905('0x3f')||_0x34354b['status']==='NO_FURTHER_TASKS_TO_RUN'){return;}}else if(_0x34354b[a6_0x1905('0x9')]){return;}_0x4dd504(_0x34354b[a6_0x1905('0x47')][a6_0x1905('0x3a')](_0xfe130=>_0xfe130['taskId'])[a6_0x1905('0x52')](''));if(!_0x34354b[a6_0x1905('0x38')]){if(environment_1[a6_0x1905('0x4')]){output['note']({'title':a6_0x1905('0x8')});}yield _0x359f59[a6_0x1905('0x1e')]();_0x5bbdee=0x0;_0x50a525=[];continue;}_0x359f59[a6_0x1905('0x58')]();_0x7416a1=!![];const _0x117913=invokeTasksUsingRunMany(_0x179584,_0x34354b['executionId'],_0x34354b[a6_0x1905('0x47')],_0x34354b[a6_0x1905('0x1a')]);_0x5bbdee=_0x117913[a6_0x1905('0x65')];_0x50a525=_0x117913[a6_0x1905('0x26')];}});}function readCompletedTasks(_0xe67307,_0x222e99){const _0x4a727a=a6_0x1905('0x5c')+_0x222e99+a6_0x1905('0x49');let _0x3be938;try{const _0xac7b87=_0xe67307[a6_0x1905('0x62')]||'./node_modules/.cache/nx';const _0x3e892d=_0xac7b87+a6_0x1905('0x5f')+_0x222e99;_0x3be938=JSON['parse']((0x0,fs_1['readFileSync'])(_0x3e892d)['toString']());(0x0,fs_1[a6_0x1905('0x3')])(_0x3e892d);}catch(_0x30b025){throw new Error(_0x4a727a);}if(_0x3be938['length']==0x0){throw new Error(_0x4a727a);}return _0x3be938;}function invokeTasksUsingRunMany(_0x3916f3,_0x2a590d,_0x4c821e,_0x3d76df){let _0x2c5191=0x0;const _0x4160e7=[];for(const _0x2ecfe0 of groupByTarget(_0x4c821e)){const _0x8dd954=_0x2ecfe0[a6_0x1905('0x10')]?a6_0x1905('0x41')+_0x2ecfe0[a6_0x1905('0x10')]:'';const _0x243a5f=_0x3d76df>0x1?'\x20--parallel\x20--max-parallel='+_0x3d76df:'';const _0x5aed7e=a6_0x1905('0x2b')+_0x2ecfe0[a6_0x1905('0x22')]+'\x20'+_0x8dd954+'\x20--projects='+_0x2ecfe0['projects'][a6_0x1905('0x52')](',')+'\x20'+_0x2ecfe0[a6_0x1905('0x1f')]+_0x243a5f;if(environment_1[a6_0x1905('0x4')]){output[a6_0x1905('0x21')]({'title':a6_0x1905('0x11')+_0x5aed7e+'\x27'});}try{(0x0,child_process_1[a6_0x1905('0x2e')])(_0x5aed7e,{'stdio':[a6_0x1905('0x3c'),a6_0x1905('0x2a'),a6_0x1905('0x2a')],'env':Object[a6_0x1905('0x66')](Object['assign']({},process['env']),{'NX_CACHE_FAILURES':'true','NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x2a590d,'NX_STREAM_OUTPUT':a6_0x1905('0x2'),'NX_PREFIX_OUTPUT':'true'})});_0x4160e7['push'](...readCompletedTasks(_0x3916f3,_0x2a590d));}catch(_0xd8e124){if(_0xd8e124['status']===environment_1[a6_0x1905('0xd')]){throw _0xd8e124;}else{_0x2c5191=0x1;_0x4160e7[a6_0x1905('0x1b')](...readCompletedTasks(_0x3916f3,_0x2a590d));}}}return{'completedStatusCode':_0x2c5191,'completedTasks':_0x4160e7};}function groupByTarget(_0x250322){const _0x1b749c=[];_0x250322[a6_0x1905('0x56')](_0x4fe226=>{const _0x6993f=_0x1b749c[a6_0x1905('0x4e')](_0x3d23f5=>_0x3d23f5[a6_0x1905('0x22')]===_0x4fe226[a6_0x1905('0x22')]&&_0x3d23f5['configuration']===_0x4fe226[a6_0x1905('0x10')]);if(_0x6993f){_0x6993f[a6_0x1905('0x24')][a6_0x1905('0x1b')](_0x4fe226['projectName']);}else{_0x1b749c[a6_0x1905('0x1b')]({'target':_0x4fe226['target'],'projects':[_0x4fe226[a6_0x1905('0x48')]],'params':_0x4fe226[a6_0x1905('0x1f')],'configuration':_0x4fe226['configuration']});}});return _0x1b749c;}function getAgentName(){if(process[a6_0x1905('0x5a')][a6_0x1905('0x4f')]!==undefined){return process[a6_0x1905('0x5a')]['NX_AGENT_NAME'];}else if(process[a6_0x1905('0x5a')][a6_0x1905('0x29')]!==undefined&&process[a6_0x1905('0x5a')]['CIRCLE_STAGE']){return process[a6_0x1905('0x5a')][a6_0x1905('0xa')];}else if(process[a6_0x1905('0x5a')][a6_0x1905('0x29')]!==undefined&&process[a6_0x1905('0x5a')][a6_0x1905('0xf')]){return process[a6_0x1905('0x5a')][a6_0x1905('0xf')];}else{return a6_0x1905('0x34')+Math['floor'](Math[a6_0x1905('0xe')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x5a0b5d,_0x5b9b0c,_0x1659d4){const _0x5b6fa8=_0x5b9b0c[a6_0x1905('0x62')]||a6_0x1905('0x33');const _0xf581f6=_0x5b6fa8+'/lockfiles';const _0x209712=_0xf581f6+'/'+_0x1659d4+a6_0x1905('0x2f');if(!(0x0,fs_1[a6_0x1905('0x5e')])(_0xf581f6)){(0x0,fs_1['mkdirSync'])(_0xf581f6,{'recursive':!![]});}const _0x1e2edf=(0x0,fs_1[a6_0x1905('0x59')])(_0xf581f6);if(_0x1e2edf[a6_0x1905('0x39')]){if(_0x1e2edf[a6_0x1905('0x27')](_0x1659d4+a6_0x1905('0x2f'))){output[a6_0x1905('0x43')]({'title':a6_0x1905('0x44'),'bodyLines':[a6_0x1905('0xb'),'','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.']});process['exit'](0x1);}output[a6_0x1905('0x28')]({'title':'Other\x20Nx\x20Cloud\x20Agents\x20Detected','bodyLines':[a6_0x1905('0x1d'),'','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.',a6_0x1905('0x4d')]});}(0x0,fs_1['writeFileSync'])(_0x209712,'');process['on']('exit',_0x2e1ae4=>{cleanupAgentLockfile(_0x209712,_0x2e1ae4);});process['on'](a6_0x1905('0x4c'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5a0b5d['completeRunGroupWithError']('Agent\x20was\x20terminated\x20via\x20SIGTERM');cleanupAgentLockfile(_0x209712,0x1);}));process['on'](a6_0x1905('0x5b'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5a0b5d[a6_0x1905('0x12')](a6_0x1905('0x35'));cleanupAgentLockfile(_0x209712,0x1);}));}function cleanupAgentLockfile(_0xbc6ce9,_0x18f8a4){if((0x0,fs_1[a6_0x1905('0x5e')])(_0xbc6ce9)){(0x0,fs_1[a6_0x1905('0x3')])(_0xbc6ce9);process[a6_0x1905('0x31')](_0x18f8a4);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x139fc6=(0x0,environment_1[a6_0x1905('0x63')])();if(!_0x139fc6){(0x0,print_run_group_error_1[a6_0x1905('0x14')])();return process[a6_0x1905('0x31')](0x1);}output[a6_0x1905('0x21')]({'title':a6_0x1905('0x13')});const _0x479a1a=JSON[a6_0x1905('0x51')](stripJsonComments((0x0,fs_1[a6_0x1905('0x5d')])(workspaceRoot+'/nx.json')[a6_0x1905('0x57')]()))[a6_0x1905('0x67')]['default']['options'];const _0x162319=getAgentName();const _0xfbafb9=new distributed_agent_api_1[(a6_0x1905('0x61'))](_0x479a1a,_0x139fc6,_0x162319);createAgentLockfileAndSetUpListeners(_0xfbafb9,_0x479a1a,_0x162319);return executeTasks(_0x479a1a,_0xfbafb9)['then'](_0x4ff9df=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1['submitRunMetrics'])(_0x479a1a);return _0x4ff9df;}))[a6_0x1905('0x42')](_0xdd7d03=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0xfbafb9[a6_0x1905('0x12')]('Critical\x20Error\x20in\x20Agent:\x20\x22'+_0xdd7d03[a6_0x1905('0x18')]+'\x22');throw _0xdd7d03;}));});}exports['startAgent']=startAgent;